<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paint</title>
</head>

<body onmousemove="coordinate(event)">
<canvas id="myCanvas" width="640" height="360" style="border:1px solid black;"></canvas>

<br>
<label>X-Coordinate:</label>
<input type="text" id="x" readonly/>
<br><br>
<label>Y-coordinate:</label>
<input type="text" id="y" readonly/>
<br><br>

<button onclick="toggleEraser()">Toggle Eraser</button>
<button onclick="clearCanvas()">Clear Canvas</button>
<br><br>

<label>Brush Size:</label>
<input type="range" min="1" max="100" value="10" class="slider" id="myRange">
<p>Value: <span id="demo"></span></p>

<button onclick="sendToServer()">Guess My Number</button>



<script>
    var slider = document.getElementById("myRange");
    var output = document.getElementById("demo"); // gets the span element to display the value
    output.innerHTML = slider.value; // displays the initial value

    const canvas = document.getElementById("myCanvas") // gives canvas element
    const ctx = canvas.getContext("2d")  // getContext returns tools and methods for drawing

    let painting = false;
    let erasing = false;
    let brushSize = parseInt(slider.value);


    slider.oninput = function () {
        brushSize = parseInt(this.value); // updates brush size based on slider value
        output.innerHTML = this.value; // updates the displayed value when the slider is moved
    }

    function startPosition(e) {
        painting = true;
        draw(e)
    }

    function endPosition() {
        painting = false;
        ctx.beginPath() // stops drawing
    }

    function draw(e) {
        if (!painting) return;

        const rect = canvas.getBoundingClientRect(); // gets the position of the canvas
        const x = e.clientX - rect.left; // calculates x position relative to canvas
        const y = e.clientY - rect.top; // calculates y position relative to canvas

        ctx.lineWidth = brushSize; // sets the width of the line based on brush size
        ctx.lineCap = "round"; // sets line cap style
        ctx.strokeStyle = erasing ? "white" : "black"; // if erasing, sets stroke color to white, else black

        ctx.lineTo(x, y);
        ctx.stroke(); // draws the line
        ctx.beginPath(); // starts a new path
        ctx.moveTo(x, y); // moves the starting point to the current position

        document.getElementById("x").value = Math.round(x); // updates x-coordinate input
        document.getElementById("y").value = Math.round(y); // updates y-coordinate input
    }

    function coordinate(event) { // Gets mouse position
        const rect = canvas.getBoundingClientRect(); // gets the position of the canvas
        let x = event.clientX - rect.left; // calculates x position relative to canvas
        let y = event.clientY - rect.top; // calculates y position relative to canvas

        document.getElementById("x").value = Math.round(x);
        document.getElementById("y").value = Math.round(y);
    }

    function toggleEraser() {
        erasing = !erasing; // toggles erasing mode
        alert(erasing ? "Eraser is ON" : "Eraser is OFF"); // if eraing is true, alert that eraser is on, else off
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function get28x28Image() {
        // Downscale to 28x28
        const smallCanvas = document.createElement("canvas");
        smallCanvas.width = 28;
        smallCanvas.height = 28;
        const smallCtx = smallCanvas.getContext("2d");
        smallCtx.drawImage(canvas, 0, 0, 28, 28);
        const imgData = smallCtx.getImageData(0, 0, 28, 28);

        // Find bounding box of non-white pixels
        let [minX, minY, maxX, maxY] = [28, 28, 0, 0];
        for (let y = 0; y < 28; y++) {
            for (let x = 0; x < 28; x++) {
                const i = (y * 28 + x) * 4;
                const r = imgData.data[i], g = imgData.data[i + 1], b = imgData.data[i + 2];
                if ((r + g + b) / 3 < 200) { // not white
                    if (x < minX) minX = x;
                    if (x > maxX) maxX = x;
                    if (y < minY) minY = y;
                    if (y > maxY) maxY = y;
                }
            }
        }
        if (maxX < minX || maxY < minY) {
            // No drawing found, return blank
            return Array(28 * 28).fill(0.0);
        }

        // Crop and scale to 20x20
        const boxW = maxX - minX + 1;
        const boxH = maxY - minY + 1;
        const digitCanvas = document.createElement("canvas");
        digitCanvas.width = boxW;
        digitCanvas.height = boxH;
        const digitCtx = digitCanvas.getContext("2d");
        digitCtx.putImageData(smallCtx.getImageData(minX, minY, boxW, boxH), 0, 0);

        // Scale to 20x20
        const scaledCanvas = document.createElement("canvas");
        scaledCanvas.width = 20;
        scaledCanvas.height = 20;
        const scaledCtx = scaledCanvas.getContext("2d");
        scaledCtx.drawImage(digitCanvas, 0, 0, 20, 20);

        // Center in 28x28
        const finalCanvas = document.createElement("canvas");
        finalCanvas.width = 28;
        finalCanvas.height = 28;
        const finalCtx = finalCanvas.getContext("2d");
        finalCtx.fillStyle = "white";
        finalCtx.fillRect(0, 0, 28, 28);
        const dx = Math.floor((28 - 20) / 2);
        const dy = Math.floor((28 - 20) / 2);
        finalCtx.drawImage(scaledCanvas, dx, dy);

        // Get normalized grayscale pixels
        const finalData = finalCtx.getImageData(0, 0, 28, 28).data;
        const grayscale = [];
        for (let i = 0; i < finalData.length; i += 4) {
            const r = finalData[i], g = finalData[i + 1], b = finalData[i + 2];
            const gray = 1.0 - ((r + g + b) / 3) / 255;
            grayscale.push(gray);
        }
        return grayscale;
    }

    function sendToServer() {
        const pixels = get28x28Image();
        fetch("http://127.0.0.1:5000/predict", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({pixels: pixels})
        })
            .then(res => res.json())
            .then(data => {
                alert("Predicted digit: " + data.prediction);
            });
    }

    canvas.addEventListener("mousedown", startPosition); // when mouse is pressed down
    canvas.addEventListener("mouseup", endPosition); // when mouse is released
    canvas.addEventListener("mousemove", draw); // when mouse is moved
</script>
</body>
</html>